# Sashihiki POC

差し引き（Sashihiki）アプリケーションの簡易版POC。2人のユーザー間で支出を登録し、差額を計算して精算するアプリケーションです。

## 概要

完成像から以下の機能を削減した簡易版：

### 削減した機能
- ユーザー認証機能
- フレンド機能
- OCR機能（レシート画像の自動読み取り）
- ファイルアップロード
- 承認ワークフロー（両ユーザーの承認）
- 1つの支出を複数のマッチングに含める機能
- マイクロサービスアーキテクチャ（gRPC/ConnectRPC）

### 残した機能
- 支出の登録・編集・削除（手動入力）
- マッチングの作成・管理
- カスタム請求金額（支出をマッチングに追加する際に金額を上書き可能）
- 精算追跡（精算日時の記録）
- 差額計算

## 機能仕様

### 支出管理
- **作成:** ユーザー、名前、金額、支払日、メモを手動入力
- **一覧:** ユーザーごとに支出を表示
- **更新:** 支出情報の編集
- **削除:** 支出の削除（マッチングに紐づいていても削除可能、スナップショットは保持）

### マッチング管理
- **作成:** 2人のユーザー間でマッチングセッションを作成
- **支出追加:** マッチングに支出を追加
  - オプション：`request_amount`で請求金額を設定可能（デフォルトは半額）
- **支出削除:** マッチングから支出を削除
- **差額計算:** 各ユーザーの請求額合計から自動的に差額を計算
- **精算:** マッチングを精算済みにする（`settled_at`を設定）
- **削除:** マッチングの削除（紐づく支出情報も削除）
- **一覧:** 精算済み・未精算マッチングの表示

## セットアップ

### 必要要件
- Node.js 24+
- pnpm 10+
- Podman（または Docker）& Compose

### 実行環境（推奨）

```bash
# 環境変数を設定
cp .env.example .env

# ビルド & 起動
make up

# 停止
make down

# データを含めて完全削除
make clean
```

http://localhost:3000 でアクセス

### ローカル開発

```bash
# 依存関係のインストール
pnpm install

# ローカル用の環境変数を設定
cp .env.example .env
cp .env.local.example .env.local

# DBのみ起動
make build
podman-compose up -d db

# 開発サーバーを起動
pnpm dev
```

## オリジナルとの主な違い

| 機能 | オリジナル | POC |
|------|-----------|-----|
| アーキテクチャ | マイクロサービス（Go, gRPC） | モノリス（Next.js） |
| 認証 | あり | なし（2ユーザーハードコード） |
| OCR | Gemini API + SQS | なし（手動入力のみ） |
| ファイル保存 | S3/MinIO | なし |
| 承認フロー | 両ユーザー承認必要 | なし（作成者が直接精算） |
| フレンド | あり | なし |
| ORM | GORM（Go） | mysql2生クエリ（TypeScript） |
| UI | 未実装 | Chakra UI v3 |
| デプロイ | 複数コンテナ | 単一アプリケーション |

## 今後の拡張案（スコープ外）

- ユーザー認証の追加
- 複数ユーザー対応
- 承認ワークフローの復活
- レシートOCR機能
- モバイル対応の改善
